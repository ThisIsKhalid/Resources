# ðŸ—„ï¸ Database Integration in NestJS

### + Repository Pattern (Senior Architecture)

Iâ€™ll focus on **Prisma-style thinking**, because:

* Itâ€™s modern
* Type-safe
* Widely used in serious NestJS projects

ðŸ“˜ Official NestJS DB overview:
ðŸ‘‰ [https://docs.nestjs.com/techniques/database](https://docs.nestjs.com/techniques/database)
ðŸ“˜ Prisma recipe (official):
ðŸ‘‰ [https://docs.nestjs.com/recipes/prisma](https://docs.nestjs.com/recipes/prisma)

---

## ðŸ§  Senior First Principle

> **NestJS does NOT care about your database**
> Thatâ€™s intentional.

You must:

* Isolate DB logic
* Keep services clean
* Make DB replaceable

---

## ðŸ§± Why Repository Pattern Matters

âŒ **Junior approach**

```ts
@Injectable()
export class UsersService {
  constructor(private prisma: PrismaService) {}

  findAll() {
    return this.prisma.user.findMany();
  }
}
```

Problems:

* Tight coupling
* Hard to test
* DB leaks into business logic

---

âœ… **Senior approach**

```
Controller
  â†“
Service (business rules)
  â†“
Repository (data access)
  â†“
ORM / DB
```

---

## ðŸ§© Target Folder Structure (Senior-Approved)

```
users/
â”œâ”€â”€ users.controller.ts
â”œâ”€â”€ users.service.ts
â”œâ”€â”€ users.module.ts
â”œâ”€â”€ repositories/
â”‚   â””â”€â”€ users.repository.ts
â”œâ”€â”€ dto/
â”œâ”€â”€ entities/
```

---

## 1ï¸âƒ£ Prisma Setup (Quick but Correct)

```bash
npm i prisma @prisma/client
npx prisma init
```

ðŸ“˜ Prisma setup via NestJS:
ðŸ‘‰ [https://docs.nestjs.com/recipes/prisma#prisma-setup](https://docs.nestjs.com/recipes/prisma#prisma-setup)

---

## 2ï¸âƒ£ PrismaService (Infrastructure Layer)

```ts
@Injectable()
export class PrismaService extends PrismaClient
  implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
  }
}
```

ðŸ“˜ Docs:
ðŸ‘‰ [https://docs.nestjs.com/recipes/prisma#prisma-service](https://docs.nestjs.com/recipes/prisma#prisma-service)

ðŸ’¡ **Senior Rule**

> ORM client = infrastructure, not business logic

---

## 3ï¸âƒ£ Repository Layer (Key Part)

```ts
@Injectable()
export class UsersRepository {
  constructor(private prisma: PrismaService) {}

  findById(id: string) {
    return this.prisma.user.findUnique({ where: { id } });
  }

  create(data: CreateUserDto) {
    return this.prisma.user.create({ data });
  }
}
```

ðŸ’¡ **Senior Rule**

> Repository speaks **database language**, not business language

---

## 4ï¸âƒ£ Service Layer (Business Rules Only)

```ts
@Injectable()
export class UsersService {
  constructor(private usersRepo: UsersRepository) {}

  async createUser(dto: CreateUserDto) {
    const existing = await this.usersRepo.findByEmail(dto.email);
    if (existing) {
      throw new BadRequestException('Email already exists');
    }

    return this.usersRepo.create(dto);
  }
}
```

ðŸ“˜ Providers & DI recap:
ðŸ‘‰ [https://docs.nestjs.com/providers](https://docs.nestjs.com/providers)

ðŸ’¡ **Senior Rule**

> Validation + rules = service
> CRUD details = repository

---

## 5ï¸âƒ£ Module Wiring (Clean DI)

```ts
@Module({
  providers: [
    PrismaService,
    UsersRepository,
    UsersService,
  ],
  exports: [UsersService],
})
export class UsersModule {}
```

ðŸ“˜ Modules docs:
ðŸ‘‰ [https://docs.nestjs.com/modules](https://docs.nestjs.com/modules)

---

## 6ï¸âƒ£ Transactions (Senior Topic)

```ts
await this.prisma.$transaction(async (tx) => {
  await tx.user.create(...);
  await tx.profile.create(...);
});
```

ðŸ“˜ Prisma transactions (used via NestJS):
ðŸ‘‰ [https://docs.nestjs.com/recipes/prisma#transactions](https://docs.nestjs.com/recipes/prisma#transactions)

ðŸ’¡ **Senior Rule**

> Transactions belong in **service layer**, not controller

---

## 7ï¸âƒ£ Multi-Database / Future-Proofing

Because you used a repository:

* Prisma â†’ TypeORM â†’ MongoDB
* No service changes
* No controller changes

ðŸ’¡ **Senior Insight**

> Repositories buy you **freedom**

---

## ðŸš« Common Junior Mistakes

| Mistake                    | Why bad        |
| -------------------------- | -------------- |
| ORM directly in controller | No abstraction |
| Fat services with queries  | Hard to test   |
| No repository layer        | Vendor lock-in |
| DB errors leaked           | Security risk  |

---

## ðŸ§  Real CRM Example

```
LeadsService
 â”œâ”€â”€ validate lead status
 â”œâ”€â”€ assign sales agent
 â””â”€â”€ call LeadsRepository

LeadsRepository
 â”œâ”€â”€ findByStatus()
 â”œâ”€â”€ updateOwner()
 â””â”€â”€ save()
```

Clean separation. Easy scaling.

---

## ðŸ§ª Senior Practice (Answer Carefully)

1. Why should services not depend directly on ORM clients?
2. What logic belongs in repositories vs services?
3. Where should transactions live?
4. How does repository pattern help testing?

