# ğŸ” Authentication & Authorization in NestJS (JWT, Guards, Roles)

Weâ€™ll build the **mental model first**, then map it to NestJS tools.

![Image](https://izolabs.tech/assets/storefront/25-Auth-Token-Flow.png)

![Image](https://miro.medium.com/0%2AmS6o3GFz1XinHkbo.jpg)

ğŸ“˜ Official docs (keep this open):
ğŸ‘‰ [https://docs.nestjs.com/security/authentication](https://docs.nestjs.com/security/authentication)

---

## ğŸ§  First: Auth vs Authorization (Many devs mix this up)

| Concept            | Question it answers         |
| ------------------ | --------------------------- |
| **Authentication** | Who are you?                |
| **Authorization**  | Are you allowed to do this? |

JWT handles **authentication**
Guards + roles handle **authorization**

---

## ğŸ§© NestJS Auth Building Blocks

NestJS auth is composed of:

| Tool       | Responsibility      |
| ---------- | ------------------- |
| Passport   | Auth framework      |
| Strategy   | How to authenticate |
| Guard      | Enforce auth        |
| JWT        | Token mechanism     |
| Decorators | Roles, metadata     |

---

## 1ï¸âƒ£ Install Required Packages

```bash
npm i @nestjs/passport passport passport-jwt
npm i @nestjs/jwt
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/security/authentication#jwt-functionality](https://docs.nestjs.com/security/authentication#jwt-functionality)

---

## 2ï¸âƒ£ Auth Module Structure (Senior Layout)

```
auth/
â”œâ”€â”€ auth.module.ts
â”œâ”€â”€ auth.service.ts
â”œâ”€â”€ auth.controller.ts
â”œâ”€â”€ strategies/
â”‚   â””â”€â”€ jwt.strategy.ts
â”œâ”€â”€ guards/
â”‚   â””â”€â”€ jwt-auth.guard.ts
â””â”€â”€ decorators/
    â””â”€â”€ roles.decorator.ts
```

ğŸ’¡ **Senior Rule**

> Auth is a feature module, not a utility.

---

## 3ï¸âƒ£ JWT Strategy (Who Are You?)

```ts
@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(config: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      secretOrKey: config.get('JWT_SECRET'),
    });
  }

  async validate(payload: any) {
    return payload; // attached to request.user
  }
}
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/security/authentication#implementing-passport-jwt](https://docs.nestjs.com/security/authentication#implementing-passport-jwt)

ğŸ’¡ **Senior Insight**

> `validate()` does NOT validate token â€” Passport already did
> You validate **user existence / status**

---

## 4ï¸âƒ£ JWT Auth Guard (Gatekeeper)

```ts
@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}
```

Use it:

```ts
@UseGuards(JwtAuthGuard)
@Get('profile')
getProfile(@Req() req) {
  return req.user;
}
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/security/authentication#guard](https://docs.nestjs.com/security/authentication#guard)

ğŸ’¡ **Senior Rule**

> Guards protect routes, not services

---

## 5ï¸âƒ£ Login Flow (Token Issuance)

```ts
async login(user: User) {
  const payload = { sub: user.id, email: user.email };

  return {
    access_token: this.jwtService.sign(payload),
  };
}
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/security/authentication#jwt-token](https://docs.nestjs.com/security/authentication#jwt-token)

ğŸ’¡ **Senior Rule**

> JWT payload should be **small & non-sensitive**

---

## 6ï¸âƒ£ Authorization: Roles & Permissions

### Roles Decorator

```ts
export const Roles = (...roles: string[]) =>
  SetMetadata('roles', roles);
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/security/authorization](https://docs.nestjs.com/security/authorization)

---

### Roles Guard

```ts
@Injectable()
export class RolesGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const roles = this.reflector.get<string[]>(
      'roles',
      context.getHandler(),
    );

    if (!roles) return true;

    const req = context.switchToHttp().getRequest();
    return roles.includes(req.user.role);
  }
}
```

Apply:

```ts
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles('admin')
@Get()
findAllUsers() {}
```

ğŸ’¡ **Senior Rule**

> Authentication first, authorization second

---

## 7ï¸âƒ£ Permissions (Real-World Upgrade)

Roles are often **not enough**.

Better model:

```
User â†’ Roles â†’ Permissions
```

Example permissions:

* `user.read`
* `user.write`
* `deal.assign`

Guard checks permissions instead of roles.

ğŸ“˜ Docs reference (conceptual):
ğŸ‘‰ [https://docs.nestjs.com/security/authorization](https://docs.nestjs.com/security/authorization)

ğŸ’¡ **Senior Insight**

> Roles = coarse-grained
> Permissions = fine-grained

---

## 8ï¸âƒ£ Public Routes (Skip Auth Cleanly)

```ts
export const Public = () => SetMetadata('isPublic', true);
```

In guard:

```ts
if (this.reflector.get('isPublic', context.getHandler())) {
  return true;
}
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/security/authentication#enable-authentication-globally](https://docs.nestjs.com/security/authentication#enable-authentication-globally)

ğŸ’¡ **Senior Rule**

> Donâ€™t scatter `@UseGuards` everywhere
> Use global guards + metadata

---

## 9ï¸âƒ£ Global Auth Guard (Production Style)

```ts
app.useGlobalGuards(new JwtAuthGuard(reflector));
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/security/authentication#global-guards](https://docs.nestjs.com/security/authentication#global-guards)

---

## ğŸš« Common Junior Mistakes

| Mistake                  | Why bad        |
| ------------------------ | -------------- |
| Auth logic in controller | Hard to test   |
| Roles in JWT payload     | Hard to revoke |
| No token expiration      | Security hole  |
| No refresh tokens        | Bad UX         |

---

## ğŸ§  Senior Auth Flow (Clean)

```
Login
 â†“
JWT issued
 â†“
Request with token
 â†“
JwtAuthGuard
 â†“
JwtStrategy validate()
 â†“
Roles/Permissions Guard
 â†“
Controller
```

---

## ğŸ§ª Senior Practice (Think Carefully)

Answer these:

1. Why shouldnâ€™t sensitive data be stored in JWT?
2. Why is `validate()` not token validation?
3. Why are Guards preferred over middleware for auth?
4. When do roles break down and permissions become necessary?

