# ğŸ”­ Interceptors, Logging, Auditing & Observability

### (Senior / Staff-Level NestJS)

If we master this, our backend becomes:

* Debuggable
* Auditable
* Measurable
* Production-safe

![Image](https://docs.nestjs.com/assets/Interceptors_1.png)

![Image](https://cdn.sanity.io/images/rdn92ihu/production/f0d13f0cf56c39bce490846bd32e50e9df403e3f-1845x766.png?auto=format\&fit=max\&h=766\&w=1845)

![Image](https://miro.medium.com/v2/resize%3Afit%3A1400/1%2At5KXYUtdY1zdbqiBN1er1A.jpeg)

ğŸ“˜ Official Interceptors docs (foundation):
ğŸ‘‰ [https://docs.nestjs.com/interceptors](https://docs.nestjs.com/interceptors)

---

## ğŸ§  Senior First Principle

> **If we canâ€™t observe it, we canâ€™t trust it**

Logs, metrics, and traces are **not optional** in real systems.

---

## 1ï¸âƒ£ Interceptors â€” The Backbone of Observability

### What Interceptors REALLY Are

* Wrap execution
* Run **before & after**
* Perfect for cross-cutting concerns

```ts
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler) {
    const now = Date.now();

    return next.handle().pipe(
      tap(() => {
        console.log(`Request took ${Date.now() - now}ms`);
      }),
    );
  }
}
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/interceptors](https://docs.nestjs.com/interceptors)

ğŸ’¡ **Senior Rule**

> If logic applies to many routes â†’ Interceptor

---

## 2ï¸âƒ£ Request/Response Logging (Real World)

### What to log (important)

âœ… Method
âœ… Path
âœ… Status code
âœ… Duration
âŒ Passwords
âŒ Tokens
âŒ PII

```ts
const req = context.switchToHttp().getRequest();
const res = context.switchToHttp().getResponse();
```

ğŸ’¡ **Senior Rule**

> Log **intent**, not sensitive data

---

## 3ï¸âƒ£ Global Logging Interceptor (Clean Setup)

```ts
app.useGlobalInterceptors(new LoggingInterceptor());
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/interceptors#global-interceptors](https://docs.nestjs.com/interceptors#global-interceptors)

---

## 4ï¸âƒ£ Structured Logging (Senior Upgrade)

âŒ Bad:

```ts
console.log('error happened');
```

âœ… Good:

```ts
logger.error({
  action: 'create_user',
  userId,
  error,
});
```

Why?

* Searchable
* Machine-readable
* Works with log platforms

ğŸ’¡ **Senior Rule**

> Logs are for machines first, humans second

---

## 5ï¸âƒ£ Auditing (CRMs & Enterprise Apps)

Audit logs answer:

> **Who did what, when, and to which resource?**

### Example audit record

```
userId: 123
action: DEAL_ASSIGNED
resourceId: 456
timestamp: now
```

### Best place for audit logic?

âœ… Interceptor

```ts
@Injectable()
export class AuditInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler) {
    const req = context.switchToHttp().getRequest();

    return next.handle().pipe(
      tap(() => {
        // save audit log
      }),
    );
  }
}
```

ğŸ’¡ **Senior Rule**

> Auditing should NOT live in controllers or services

---

## 6ï¸âƒ£ Performance Monitoring (Timing)

Track slow endpoints:

```ts
const start = process.hrtime.bigint();
const duration = Number(process.hrtime.bigint() - start) / 1e6;
```

Use for:

* API latency
* SLA monitoring
* Bottleneck detection

ğŸ“˜ Interceptor timing example:
ğŸ‘‰ [https://docs.nestjs.com/interceptors](https://docs.nestjs.com/interceptors)

---

## 7ï¸âƒ£ Exception Logging (Donâ€™t Miss Errors)

Use **Exception Filters** to log once, consistently.

```ts
@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    // log exception
    // format response
  }
}
```

ğŸ“˜ Docs:
ğŸ‘‰ [https://docs.nestjs.com/exception-filters](https://docs.nestjs.com/exception-filters)

ğŸ’¡ **Senior Rule**

> Never log errors in every controller
> Centralize it.

---

## 8ï¸âƒ£ Correlation IDs (Very Senior)

Why?

* One request = many logs
* Correlation ID ties them together

Flow:

```
Request â†’ assign requestId â†’ log everywhere
```

Usually done via:

* Middleware (assign ID)
* Logger context

ğŸ’¡ **Senior Insight**

> Debugging prod without correlation IDs is pain

---

## 9ï¸âƒ£ Metrics & Tracing (Conceptual)

Even if we donâ€™t implement now, we should know:

* Metrics â†’ counters, histograms
* Tracing â†’ request flow across services

NestJS integrates cleanly because of:

* Interceptors
* DI
* Modular design

ğŸ“˜ Docs (conceptual):
ğŸ‘‰ [https://docs.nestjs.com/interceptors](https://docs.nestjs.com/interceptors)

---

## ğŸš« Common Junior Mistakes

| Mistake                | Why bad            |
| ---------------------- | ------------------ |
| console.log everywhere | No structure       |
| Logging sensitive data | Security risk      |
| No audit logs          | Compliance failure |
| No performance metrics | Blind in prod      |

---

## ğŸ§  Senior Mental Model

| Concern    | Tool         |
| ---------- | ------------ |
| Logging    | Interceptors |
| Auditing   | Interceptors |
| Errors     | Filters      |
| Auth       | Guards       |
| Validation | Pipes        |

Each tool has **one job**.

---

## ğŸ§ª Practice

Answer these:

1. Why are interceptors ideal for logging?
2. Why shouldnâ€™t services handle audit logs?
3. What data should NEVER be logged?
4. Why are correlation IDs critical in production?

---

## ğŸ Where We Are Now

Weâ€™ve covered:

* NestJS core architecture
* DI & modules
* Auth & permissions
* Databases & repositories
* Production observability


